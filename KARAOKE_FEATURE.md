# Karaoke Lyrics Feature - 卡拉OK歌詞功能

## 功能概述

這個新功能為 Palmus 音樂播放器添加了類似 Apple Music 的逐字卡拉OK歌詞效果。該功能僅在歌曲具有逐字時間數據（YRC）時激活，對於只有行級歌詞（LRC）的歌曲會自動回退到原有行為。

## 技術實現

### 1. 數據層面 (PlayerStore)

- **YRC 數據結構**: 已在 `playerStore.ts` 中定義，包含每行歌詞的逐字時間信息
- **解析**: 使用 `native-lyrics-tools` 庫的 `parseYRC` 函數解析原始 YRC 數據
- **國際化**: 支持使用 OpenCC 將簡體中文轉換為繁體中文

### 2. 組件層面

#### KaraokeWord 組件 (`components/KaraokeWord.tsx`)

**功能**:
- 處理單個單詞的卡拉OK效果
- 根據當前播放時間計算單詞狀態（未開始/播放中/已播放）
- 使用 CSS 漸變實現平滑的"擦除"效果

**關鍵特性**:
- 時間同步：將毫秒時間轉換為秒以匹配播放器時間
- 漸變效果：實時計算播放進度並應用相應的漸變
- 狀態管理：三種狀態（upcoming/playing/played）的精確處理

#### FullLyrics 組件更新

**改進**:
- 條件渲染：檢測是否有 YRC 數據並相應渲染
- 智能回退：沒有 YRC 數據時使用傳統 LRC 顯示
- 空格處理：正確處理單詞間的空格

### 3. 視覺效果

- **未播放部分**: 半透明白色 (`rgba(255, 255, 255, 0.4)`)
- **已播放部分**: 不透明白色 (`rgba(255, 255, 255, 1)`)
- **過渡效果**: 平滑的左到右漸變"擦除"效果
- **文字陰影**: 增強對比度的陰影效果

## 使用方式

### 自動激活

功能會自動檢測歌曲是否具有 YRC 數據：

1. **有 YRC 數據**: 當前播放行使用卡拉OK效果，其他行顯示完整文字
2. **無 YRC 數據**: 回退到原有的行級歌詞顯示

### 開發者選項

在開發環境下，可以在瀏覽器控制台看到實時的調試信息：
```
KaraokeWord: "Hello" - playing - 45.2%
```

## 支持的數據格式

### YRC 格式
```typescript
interface YRCLine {
  startTime: number    // 行開始時間（毫秒）
  endTime: number      // 行結束時間（毫秒）
  words: Array<{
    startTime: number  // 單詞開始時間（毫秒）
    endTime: number    // 單詞結束時間（毫秒）
    word: string       // 單詞文字
  }>
}
```

### LRC 回退
對於沒有 YRC 數據的歌曲，系統會自動使用 LRC 格式的行級歌詞。

## 性能優化

- **記憶化計算**: 使用 `useMemo` 避免不必要的重新計算
- **條件渲染**: 僅在當前行使用卡拉OK效果，減少計算負擔
- **平滑動畫**: 播放中的單詞不使用 CSS 過渡以確保實時響應

## 瀏覽器兼容性

- **現代瀏覽器**: 支持所有現代瀏覽器的 `background-clip: text` 特性
- **備用方案**: 不支持的瀏覽器會顯示正常文字（降級優雅）

## 測試建議

1. **有 YRC 數據的歌曲**: 驗證卡拉OK效果是否正常工作
2. **只有 LRC 數據的歌曲**: 確保回退機制正常
3. **無歌詞的歌曲**: 檢查錯誤處理
4. **網絡延遲**: 測試歌詞加載延遲的處理

## 故障排除

### 常見問題

1. **卡拉OK效果不顯示**
   - 檢查歌曲是否有 YRC 數據
   - 確認 `native-lyrics-tools` 庫正常工作

2. **時間不同步**
   - 驗證時間單位轉換（毫秒 → 秒）
   - 檢查音頻播放器的時間準確性

3. **視覺效果異常**
   - 確認瀏覽器支持 `background-clip: text`
   - 檢查 CSS 漸變語法

## 未來擴展

- 支持多語言歌詞的卡拉OK效果
- 添加自定義顏色主題
- 支持垂直排列的歌詞
- 添加歌詞字體大小動態調整
